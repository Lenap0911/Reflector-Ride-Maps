<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bike Sensor Data Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <link href="styles.css" rel="stylesheet" />
  <link href="manual.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.4/dist/pmtiles.js"></script>
  <script>
    var mapboxgl = maplibregl;
  </script>
</head>
<body>
<div id="mapContainer">
  <button id="fullscreenBtn" title="Toggle Fullscreen">‚õ∂</button>
  
  <!-- Manual Toggle Button -->
  <button id="manualToggleBtn" title="Open User Manual">
    üìò Manual
  </button>

  <!-- Sliding Manual Panel -->
  <div id="manualPanel">

    <div class="manual-header">
    <h3>Cycling Behaviour Dashboard</h3>
    <button id="manualCloseBtn" title="Close Manual">‚úï</button>
  </div>

  <div class="manual-content">

    <section>
      <h4>Purpose of the Dashboard</h4>
      <p>
        This dashboard is designed for officials and urban planners within the
        Municipality of Amsterdam to demonstrate the potential of
        <strong>cycling-behaviour-informed policy planning</strong>.
      </p>
      <p>
        It combines self-collected cycling sensor data (speed and braking behaviour)
        with third-party infrastructure data (road quality and traffic lights).
      </p>
      <p class="note">
        The dataset is so far based on <strong>112 recorded cycling trips</strong>
        and should be interpreted as exploratory and illustrative.
      </p>
    </section>

    <section>
      <h4>How to Read the Map</h4>
      <p>
        The map visualises Amsterdam‚Äôs cycling network using selectable data layers.
        Each layer has its own scale, legend, and policy interpretation.
      </p>
      <p>
        White circles indicate locations where no corresponding sensor data is
        available for the selected filter.
      </p>
    </section>

    <section>
      <h4>Available Data Layers</h4>

      <h5>Speed</h5>
      <p>
        Displays average cycling speed across recorded trips, supporting the
        identification of slow or fast corridors.
      </p>

      <h5>Road Quality</h5>
      <p>
        Based on third-party infrastructure data, categorised from ‚ÄúPerfect‚Äù to
        ‚ÄúNo road‚Äù, supporting infrastructure assessment and maintenance planning.
      </p>

      <h5>Traffic Light Analysis</h5>
      <p>
        Analyses cyclist behaviour within a 25-metre radius around traffic lights.
      </p>
      <ul>
        <li>
          <strong>Safety ‚Äì Sudden Braking:</strong> detected when cyclists enter the
          zone at speeds below 5 km/h, indicating potential safety risks.
        </li>
        <li>
          <strong>Efficiency ‚Äì Extended Stops:</strong> measured as the percentage
          of time spent stopped or nearly stopped (below 2 km/h).
        </li>
        <li>
          <strong>Balanced:</strong> combines both indicators.
        </li>
      </ul>

      <h5>Averaged Road Segments</h5>
      <p>
        Aggregates speed and road quality into averaged scores per road segment,
        supporting corridor-level analysis.
      </p>

      <h5>Composite Score (Quality + Speed)</h5>
      <p>
        Combines infrastructure condition and cycling performance into a single
        indicator for comparative assessment.
      </p>
    </section>

    <section>
      <h4>Using Filters and Interpretations</h4>
      <p>
        Filters can be activated individually or in combination. Each combination
        reflects a deliberate analytical perspective chosen by the user.
      </p>
      <p>
        The dashboard does not prescribe a single interpretation, but supports
        exploratory, policy-driven analysis.
      </p>
    </section>

    <section>
      <h4>Responsible Use</h4>
      <p>
        Behavioural indicators should be understood as signals rather than
        definitive diagnoses. Results should be interpreted alongside contextual
        knowledge of street design, traffic conditions, and policy objectives.
      </p>
    </section>

  </div>
</div>
  
  <div id="map"></div>

  <div id="controls">
    <h3>Bike Routes</h3>

    <div class="control-group">
      <label>üîç Find Trip:</label>
      <div style="display: flex; gap: 5px;">
        <input type="text" id="tripSearchInput" placeholder="e.g., 602CA_Trip1" 
              style="flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
        <button id="tripSearchButton" style="padding: 5px 10px;">Search</button>
      </div>
    </div>
    
    <div class="control-group">
      <label class="checkbox-label">
        <input type="checkbox" id="speedColorsCheckbox">
        Speed
      </label>
    </div>
    
    <div class="radio-group" id="speedModeGroup">
      <label class="radio-label">
        <input type="radio" name="speedMode" value="gradient" checked>
        Smooth Gradient
      </label>
      <label class="radio-label">
        <input type="radio" name="speedMode" value="categories">
        Speed Categories
      </label>
    </div>

    <div class="control-group">
      <label class="checkbox-label">
        <input type="checkbox" id="roadQualityCheckbox">
        Road Quality
      </label>
    </div>

    <div class="control-group">
      <label class="checkbox-label">
        <input type="checkbox" id="trafficLightsCheckbox">
        Traffic Light Analysis
      </label>
    </div>

    <div class="radio-group" id="analysisModeGroup">
      <label class="radio-label">
        <input type="radio" name="analysisMode" value="safety" checked>
        Safety (Sudden Braking)
      </label>
      <label class="radio-label">
        <input type="radio" name="analysisMode" value="efficiency">
        Efficiency (Extended Stops)
      </label>
      <label class="radio-label">
        <input type="radio" name="analysisMode" value="overall">
        Balanced (Both)
      </label>
    </div>

    <div class="control-group">
      <label class="checkbox-label">
        <input type="checkbox" id="averagedSegmentsCheckbox">
        Averaged Road Segments
      </label>
    </div>

    <div class="radio-group" id="averagedModeGroup" style="display: none;">
      <label class="radio-label">
        <input type="radio" name="averagedMode" value="composite" checked>
        Composite Score (Quality + Speed)
      </label>
      <label class="radio-label">
        <input type="radio" name="averagedMode" value="speed">
        Average Speed
      </label>
      <label class="radio-label">
        <input type="radio" name="averagedMode" value="quality">
        Road Quality
      </label>
    </div>

    <button id="resetButton">‚Ü© Reset View</button>
  </div>

  <div id="stats">
    <h4>Trip Info</h4>
    <div class="stat-row" id="statTripRow">
      <span class="stat-label">Total trips:</span>
      <span class="stat-value" id="statTrips">‚Äî</span>
    </div>
    <div class="stat-row" id="statDistanceRow">
      <span class="stat-label">Total distance:</span>
      <span class="stat-value" id="statDistance">‚Äî</span>
    </div>
    <div class="stat-row" id="statAvgSpeedRow">
      <span class="stat-label">Average speed:</span>
      <span class="stat-value" id="statAvgSpeed">‚Äî</span>
    </div>
    <div class="stat-row" id="statTotalTimeRow">
      <span class="stat-label">Total time:</span>
      <span class="stat-value" id="statTotalTime">‚Äî</span>
    </div>
    <div class="stat-row" id="selectedTripRow">
      <span class="stat-label">Selected:</span>
      <span class="stat-value" id="selectedTrip">‚Äî</span>
    </div>
  </div>

  <div class="legend" id="speedLegend">
    <h4>Speed (km/h)</h4>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #808080;"></div>
      <span>Stopped (0-2)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #DC2626;"></div>
      <span>Very Slow (2-5)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #F97316;"></div>
      <span>Slow (5-10)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FACC15;"></div>
      <span>Moderate (10-15)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #22C55E;"></div>
      <span>Fast (15-20)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #3B82F6;"></div>
      <span>Very Fast (20-25)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #6366F1;"></div>
      <span>Extreme (25+)</span>
    </div>
  </div>

  <div class="legend" id="roadQualityLegend">
    <h4>Road Quality</h4>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #22C55E;"></div>
      <span>1 - Perfect</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #84CC16;"></div>
      <span>2 - Normal</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FACC15;"></div>
      <span>3 - Outdated</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #F97316;"></div>
      <span>4 - Bad</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #DC2626;"></div>
      <span>5 - No road</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #808080;"></div>
      <span>Unknown</span>
    </div>
  </div>

  <div class="legend" id="trafficLightLegend">
    <h4>Traffic Light Analysis</h4>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #16A34A;"></div>
      <span>Excellent+ (0-10)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #22C55E;"></div>
      <span>Excellent (10-20)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #4ADE80;"></div>
      <span>Good+ (20-30)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #84CC16;"></div>
      <span>Good (30-40)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FDE047;"></div>
      <span>Moderate+ (40-50)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FACC15;"></div>
      <span>Moderate (50-60)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FB923C;"></div>
      <span>Poor+ (60-70)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #F97316;"></div>
      <span>Poor (70-80)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #DC2626;"></div>
      <span>Critical (80+)</span>
    </div>
    <div class="speed-legend-item">
      <div class="speed-color-box" style="background: #FFFFFF; border: 1px solid #ccc;"></div>
      <span>No Data</span>
    </div>
  </div>

  <div class="legend" id="averagedSegmentsLegend" style="display: none;">
    <h4>Averaged Road Segments</h4>
    
    <!-- Composite Score Legend (default) -->
    <div id="compositeLegendItems">
      <p style="font-size: 11px; margin: 0 0 8px 0; color: #666;">
        Combined score based on quality and speed
      </p>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #22C55E;"></div>
        <span>Excellent (0-20)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #84CC16;"></div>
        <span>Good (20-40)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #FACC15;"></div>
        <span>Moderate (40-60)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #F97316;"></div>
        <span>Poor (60-80)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #DC2626;"></div>
        <span>Critical (80-100)</span>
      </div>
    </div>
    
    <!-- Speed Legend -->
    <div id="avgSpeedLegendItems" style="display: none;">
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #DC2626;"></div>
        <span>Very Slow (0-5 km/h)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #F97316;"></div>
        <span>Slow (5-10 km/h)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #FACC15;"></div>
        <span>Moderate (10-15 km/h)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #22C55E;"></div>
        <span>Fast (15-20 km/h)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #3B82F6;"></div>
        <span>Very Fast (20-25 km/h)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #6366F1;"></div>
        <span>Extreme (25+ km/h)</span>
      </div>
    </div>
    
    <!-- Quality Legend -->
    <div id="avgQualityLegendItems" style="display: none;">
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #22C55E;"></div>
        <span>Perfect (1.0-1.5)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #84CC16;"></div>
        <span>Normal (1.5-2.5)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #FACC15;"></div>
        <span>Outdated (2.5-3.5)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #F97316;"></div>
        <span>Bad (3.5-4.5)</span>
      </div>
      <div class="speed-legend-item">
        <div class="speed-color-box" style="background: #DC2626;"></div>
        <span>No Road (4.5-5.0)</span>
      </div>
    </div>
  </div>

</div>

<script>
  // Fullscreen functionality
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const mapContainer = document.getElementById('mapContainer');
  
  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement && 
        !document.webkitFullscreenElement && 
        !document.mozFullScreenElement && 
        !document.msFullscreenElement) {
      if (mapContainer.requestFullscreen) {
        mapContainer.requestFullscreen();
      } else if (mapContainer.webkitRequestFullscreen) {
        mapContainer.webkitRequestFullscreen();
      } else if (mapContainer.mozRequestFullScreen) {
        mapContainer.mozRequestFullScreen();
      } else if (mapContainer.msRequestFullscreen) {
        mapContainer.msRequestFullscreen();
      }
      fullscreenBtn.textContent = '‚õ∂';
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      fullscreenBtn.textContent = '‚õ∂';
    }
  });
  
  document.addEventListener('fullscreenchange', updateFullscreenButton);
  document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
  document.addEventListener('mozfullscreenchange', updateFullscreenButton);
  document.addEventListener('MSFullscreenChange', updateFullscreenButton);
  
  function updateFullscreenButton() {
    if (document.fullscreenElement || 
        document.webkitFullscreenElement || 
        document.mozFullScreenElement || 
        document.msFullscreenElement) {
      fullscreenBtn.textContent = '‚õ∂';
      fullscreenBtn.title = 'Exit Fullscreen';
    } else {
      fullscreenBtn.textContent = '‚õ∂';
      fullscreenBtn.title = 'Enter Fullscreen';
    }
  }

  // Handle legend switching for averaged segments
  document.querySelectorAll('input[name="averagedMode"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const mode = e.target.value;
      
      // Hide all legend items
      document.getElementById('compositeLegendItems').style.display = 'none';
      document.getElementById('avgSpeedLegendItems').style.display = 'none';
      document.getElementById('avgQualityLegendItems').style.display = 'none';
      
      // Show relevant legend
      if (mode === 'composite') {
        document.getElementById('compositeLegendItems').style.display = 'block';
      } else if (mode === 'speed') {
        document.getElementById('avgSpeedLegendItems').style.display = 'block';
      } else if (mode === 'quality') {
        document.getElementById('avgQualityLegendItems').style.display = 'block';
      }
    });
  });
</script>

<script type="module" src="config.js"></script>
<script type="module" src="app.js"></script>
<script src="manual.js"></script>
</body>
</html>